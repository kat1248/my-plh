<!doctype HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#1a3d5c"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Signal Cartel's Little Helper</title>
    <link type="text/css" rel="stylesheet" href="{{url_for('static', filename='tablestyle.css')}}"/>
    <link type="text/css" rel="stylesheet" href="{{url_for('static', filename='datastyle.css')}}"/>
    <script src="{{ url_for('static', filename='jquery-3.2.1.min.js') }}"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.16/b-1.5.1/fh-3.1.3/rg-1.0.2/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.16/b-1.5.1/fh-3.1.3/rg-1.0.2/datatables.min.js"></script>
  </head>
  <body style="background-color: #1a3d5c;">
    <div class="container">
    <H1 style="text-align: center; color: White; background-color: #1a3d5c;padding: 10px;">Signal Cartel's Little Helper</H1>
      <table id="chars" class="compact stripe order-column hover">
          <thead>
            <tr class="header">
              <th></th>
              <th>Name</th>
              <th>Age</th>
              <th>Danger Level</th>
              <th>Gang %</th>
              <th>Security</th>
              <th>Kills</th>
              <th>Losses</th>
              <th class="nothumb"></th>
              <th>Corp</th>
              <th>Alliance</th>
              <th>Last Activity</th>
              <th>Time in Corp</th>
              <th>Corp ID</th>
              <th>Corp Danger</th>
              <th>NPC Corp</th>
            </tr>
          </thead>
          <tfoot>
            <tr class="header">
              <th></th>
              <th>Name</th>
              <th>Age</th>
              <th>Danger Level</th>
              <th>Gang %</th>
              <th>Security</th>
              <th>Kills</th>
              <th>Losses</th>
              <th></th>
              <th>Corp</th>
              <th>Alliance</th>
              <th>Last Activity</th>
              <th>Time in Corp</th>
              <th>Corp ID</th>
              <th>Corp Danger</th>
              <th>NPC Corp</th>
            </tr>
          </tfoot>
          <tbody>
          </tbody>
      </table> 
     <form action="{{ url_for('local') }}" method="POST">
        <textarea name="characters" placeholder="Enter Character Names (maximum {{ max_chars }})" rows=10 cols=35></textarea>
        <p><input type="Submit" value="Submit" maxlength="1000"/>
        <input type="reset" /></p>
     </form>
      <p><label id="group-button"></label>
     </div>
    <script type="text/javascript">
      "use strict";
      var char_data = [ {% for char in charlist %}
        { "name": "{{ char.name }}",
          "thumb": "",
          "image": "https://image.eveonline.com/Character/{{ char.character_id }}_512.jpg",
          "has_killboard": {% if char.has_killboard %}true{% else %}false{% endif %},
          "zkillboard": "https://zkillboard.com/character/{{ char.character_id }}/",
          "age": "{{ char.age }}",
          "danger": {{ char.danger }},
          "gang": {{ char.gang }},
          "security": {{ char.security }},
          "kills": {{ char.kills }},
          "losses": {{ char.losses }},
          "corp_name": "{{ char.corp_name }}",
          "corp_thumb": "",
          "alliance_name": "{{ char.alliance_name }}",
          "last_kill": "{{ char.last_kill }}", 
          "corp_age": "{{ char.corp_age }}",
          "corp_id": {{ char.corp_id }},
          "corp_danger": {{ char.corp_danger }},
          "is_npc_corp": {% if char.is_npc_corp %}true{% else %}false{% endif %},
          "char_id": {{ char.character_id }}, }, {% endfor %}]
      var table;
      var dataFormatting = (function () {
        return {
          char_name: function ( data, type, row ) {
            if ( row.has_killboard ) {
              return '<a href="https://zkillboard.com/character/{0}/" target="_blank" rel="noopener">{1}</a>'.format( row.char_id, row.name )
            } else {
              return data
            }
          },
          corp_name: function ( data, type, row ) {
            return '<a href="https://zkillboard.com/corporation/{0}/" target="_blank" rel="noopener">{1}</a>'.format( row.corp_id, row.corp_name )
          },
          security: function ( data, type, row ) {
            return '<a href="https://zkillboard.com/corporation/{0}/" target="_blank" rel="noopener">{1}</a>'.format( row.corp_id, row.corp_name )
          },
          char_thumb: function ( data, type, row ) {
            var img = '<img src="https://image.eveonline.com/Character/{0}_64.jpg" height="32" width="32" alt="{1} thumbnail">'.format( row.char_id, row.name )
            var span = '<span><img src="https://image.eveonline.com/Character/{0}_512.jpg" alt= alt="{0} portrait"></span>'.format( row.char_id, row.name )
            return img + span
          },
          corp_thumb: function ( data, type, row ) {
            return '<img src="https://imageserver.eveonline.com/Corporation/{0}_64.png" height="32" width="32" alt="{1} thumbnail" title="Corporation Danger Level: {2}">'.format( row.corp_id, row.corp_name, row.corp_danger )
          },
          corp_age: function ( data, type, row ) {
            return data + ' days'
          },
          row_group: function ( rows, group ) {
            var alliance = rows.data().pluck( 'alliance_name' ).reduce( function ( a, b ) { return b; } )
            var corp_id = rows.data().pluck( 'corp_id' ).reduce( function ( a, b ) { return b; } )
            var corp_danger = rows.data().pluck( 'corp_danger' ).reduce( function ( a, b ) { return b; } )
            var npc_corp = rows.data().pluck( 'is_npc_corp' ).reduce( function ( a, b ) { return b; } )
            return groupRow( group, alliance, corp_id, corp_danger, npc_corp )
          },
          postProcess: function( row, data, dataIndex ) {
            if ( data.danger > 50) {
              $('td:eq(0)', row).addClass( 'danger_thumb' );
              $('td:eq(3)', row).addClass( 'danger' );
            } else {
              $('td:eq(0)', row).addClass( 'thumb' );
            }
            if ( data.security < 0 ) {
              $('td:eq(5)', row).addClass( 'danger' );
            }
            if ( data.corp_danger > 50 ) {
              $('td:eq(8)', row).addClass( 'danger_thumb' );
            } else if ( data.is_npc_corp ) {
              $('td:eq(8)', row).addClass( 'safe_thumb' );              
            } else {
              $('td:eq(8)', row).addClass( 'blank_thumb' );
            }
          }
        }
      })();
      String.prototype.format = function () {
          var args = arguments;
          return this.replace(/\{(\d+)\}/g, function (m, n) { return args[n]; });
      }
      function groupRow( group, alliance_name, corp_id, corp_danger, npc_corp ) {
          var img = '<td class="blank_thumb"><img src="https://imageserver.eveonline.com/Corporation/{0}_64.png" height="32" width="32"></td>'.format( corp_id )
          var corp_class = ""
          if ( corp_danger > 50 ) {
            corp_class = 'class="danger"'
          } else if ( npc_corp ) {
            corp_class = 'class="safe"'
          }
          var alliance = ""
          if ( alliance_name != "" ) {
            alliance = '  ({0})'.format( alliance_name )
          }
          var name = '<td {0}>{1}{2}</td>'.format( corp_class, group, alliance )
          return img + name
      }
      function toggleCorpGrouping() {
          var vis = !table.column(9).visible();
          if ( vis ) {
            table.button(0).text( 'Group by Corporation')
            table.column(1).order( 'asc' )
            table.rowGroup().disable()
          } else {
            table.button(0).text( 'Ungroup' )
            table.column(9).order( 'asc' )
            table.rowGroup().enable()
          }
          table.column(8).visible( vis, false );
          table.column(9).visible( vis, false);
          table.column(10).visible( vis, false );
          table.draw();
      }
      $(document).ready( function () {
        table = $( '#chars' ).DataTable( {
          order: [ [ 9, 'asc' ], [ 1, 'asc' ] ],
          data: char_data,
          deferRender: true,
          createdRow: dataFormatting.postProcess,
          columns: [
            { data: 'thumb', render: dataFormatting.char_thumb },
            { data: 'name', render: dataFormatting.char_name },
            { data: 'age' },
            { data: 'danger', className: 'dt-body-center' },
            { data: 'gang', className: 'dt-body-center' },
            { data: 'security', className: 'dt-body-center', render: $.fn.dataTable.render.number( ',', '.', 2 ) },
            { data: 'kills', className: 'dt-body-center' },
            { data: 'losses', className: 'dt-body-center' },
            { data: 'corp_thumb', render: dataFormatting.corp_thumb },
            { data: 'corp_name', render: dataFormatting.corp_name },
            { data: 'alliance_name' },
            { data: 'last_kill' },
            { data: 'corp_age', render: dataFormatting.corp_age },
            { data: 'corp_id' },
            { data: 'corp_danger' },
            { data: 'is_npc_corp' },
            { data: 'char_id' },
          ],
          columnDefs: [
            { "orderable": false, "targets": [ 0, 2, 8, 11, 12 ] },
            { "visible": true, "targets": [ 9 ] },
            { "visible": false, "targets": [ 13, 14, 15, 16 ] }
          ],
          buttons: [
            {
              text: 'Group by Corporation',
              action: function ( e, dt, node, config ) {
                toggleCorpGrouping();
              }
            }
          ],
          info: false,
          paging: true,
          rowGroup: {
            dataSrc: 'corp_name',
            enable: false,
            startRender: dataFormatting.row_group
          },
          searching: true,
          fixedHeader: true,
          autoWidth: false,
         });
         table.button().container().appendTo( $( '#group-button' ) )
      });
    </script>
  </body>
</html>
